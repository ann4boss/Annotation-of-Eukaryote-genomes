#!/bin/bash

#SBATCH --job-name=BUSCO_Run
#SBATCH --partition=pibu_el8
#SBATCH --cpus-per-task=32
#SBATCH --mem=64G
#SBATCH --time=0-12:00:00
#SBATCH --output=./logs/output/%x_%j.out
#SBATCH --error=./logs/error/%x_%j.err

#==============================================================================
# SCRIPT: 17_run_busco_assessment.sh
# DESCRIPTION: Executes the BUSCO quality assessment on the longest-isoform
#              protein and transcript sets using the Brassicales reference
#              lineage. This step generates a key metric for annotation completeness.
# AUTHOR: Anna Boss
# DATE: Nov 2025
#==============================================================================

#*-----Variables and File Setup------------------------------------------------*
WORKDIR="/data/users/aboss/annotation_of_eukaryote_genome"
# Output directory (same as previous step)
OUTDIR="$WORKDIR/results/10_BUSCO"
# Input files
PROTEIN_INPUT="$OUTDIR/longest_proteins.fasta"
TRANSCRIPT_INPUT="$OUTDIR/longest_transcripts.fasta"

# BUSCO parameters
LINEAGE="brassicales_odb10"
PROT_OUTPUT_DIR="busco_protein_output"
TRANS_OUTPUT_DIR="busco_transcript_output"


#*-----Prerequisites and Directory Setup---------------------------------------*
echo "Loading required modules (BUSCO)..."
module load BUSCO/5.4.2-foss-2021a

mkdir -p "$OUTDIR"
cd "$OUTDIR" || exit
echo "Working directory set to: $OUTDIR"


#*-----Run BUSCO Assessment----------------------------------------------------*
echo "1. Starting BUSCO run on PROTEIN set..."
if [ ! -f "$PROTEIN_INPUT" ]; then
    echo "ERROR: Protein input file not found at $PROTEIN_INPUT. Exiting."
    exit 1
fi
busco -i "$PROTEIN_INPUT" -l "$LINEAGE" -o "$PROT_OUTPUT_DIR" -m proteins --cpu 32

echo "2. Starting BUSCO run on TRANSCRIPT set..."
if [ ! -f "$TRANSCRIPT_INPUT" ]; then
    echo "ERROR: Transcript input file not found at $TRANSCRIPT_INPUT. Exiting."
    exit 1
fi
busco -i "$TRANSCRIPT_INPUT" -l "$LINEAGE" -o "$TRANS_OUTPUT_DIR" -m transcriptome --cpu 32

#*-----Process Results and Generate Plot---------------------------------------*
echo "3. Copying BUSCO summary files to main output directory..."

# Define the full path to the specific summary files generated by BUSCO
PROTEIN_SUMMARY="${PROT_OUTPUT_DIR}/short_summary.specific.${LINEAGE}.${PROT_OUTPUT_DIR}.txt"
TRANSCRIPT_SUMMARY="${TRANS_OUTPUT_DIR}/short_summary.specific.${LINEAGE}.${TRANS_OUTPUT_DIR}.txt"

# Copy and rename summary files for clarity
cp "${PROTEIN_SUMMARY}" "short_summary.specific.${LINEAGE}.proteins.txt"
cp "${TRANSCRIPT_SUMMARY}" "short_summary.specific.${LINEAGE}.transcripts.txt"

echo "4. Downloading and running plot generation script..."
# Download the generate_plot.py script from GitLab
PLOT_SCRIPT="generate_plot.py"
wget -O "$PLOT_SCRIPT" "https://gitlab.com/ezlab/busco/-/raw/5.4.2/scripts/generate_plot.py"

# Check if download was successful before executing
if [ ! -f "$PLOT_SCRIPT" ]; then
    echo "Error: Failed to download $PLOT_SCRIPT. Plot generation skipped."
    exit 1
fi

# Run the plot generation. -wd uses the current directory ($OUTDIR)
python3 "$PLOT_SCRIPT" -wd .

echo "BUSCO assessment complete. Results and plot saved to $OUTDIR."


#*-----Expected Result Files in ${OUTDIR}--------------------------------------*
# busco_protein_output/ (Full BUSCO results directory)
# busco_transcript_output/ (Full BUSCO results directory)
# summary.brassicales_odb10.proteins.txt (Summary file for proteins)
# summary.brassicales_odb10.transcripts.txt (Summary file for transcripts)
# busco_figure.png (Graphical summary plot)